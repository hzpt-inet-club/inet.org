# è®¾è®¡æ¨¡å¼ç¬¬åå…«èŠ‚

## è§‚å¯Ÿè€…æ¨¡å¼

### å¼•è¨€

è€è¯è¯´çš„å¥½ï¼šâ€œ`ä½ çŸ¥é“çš„è¶Šå¤šè¶Šè§‰çš„è‡ªå·±æ— çŸ¥ã€‚`â€

ç¼–ç¨‹è·¯ä¸Šçš„çŸ¥è¯†å¯ä»¥è¯´æ˜¯æ— ç©·æ— å°½çš„ï¼Œå°±åƒåˆšåˆšå­¦è¿‡javaçš„æ—¶å€™ï¼Œæ•¢æ”¾å‡ºè±ªè¨€å£®è¯­ï¼Œæˆ‘ç²¾é€šJavaï¼›ä½†æ˜¯ç°åœ¨çš„æˆ‘åªæ•¢è¯´è‡ªå·±ç²—ç•¥äº†è§£è¿‡javaã€‚å½“ä¸€ä¸ªäººçš„è§†é‡å’Œæ ¼å±€çš„æ‰©å¤§ï¼Œä¼šè®©æˆ‘ä»¬è‡ªå·±å‘ç°ä¹‹å‰çš„è‡ªå·±åˆå¤šä¹ˆæ¸ºå°ï¼Œå°±å¦‚åŒç«™åœ¨åœ°çƒçœ‹å®‡å®™ï¼Œç«™åœ¨å®‡å®™çœ‹åœ°çƒæ˜¯ä¸€æ ·çš„ã€‚ä½†æ­£å› ä¸ºèƒ¸æ€€å’Œçœ¼ç•Œçš„æå‡è®©æˆ‘ä»¬æœ‰äº†æ›´å¤šçš„è®¤è¯†ï¼Œä¹Ÿé€æ¸å­¦ä¼šäº†æ›´å¤šçš„æŠ€èƒ½ã€‚è™½ç„¶ä¸çŸ¥é“çš„è¶Šæ¥è¶Šå¤šï¼Œä½†ä¹Ÿå› æ­¤ç»™è‡ªå·±å¡«å……äº†æ›´å¤šçš„æŠ€æœ¯æ ˆï¼Œè®©è‡ªå·±è¶Šæ¥è¶Šå¼ºå¤§ã€‚

è€å¸ˆä»¬å¸¸è¯´ï¼šâ€œ`å½“ä¸€ä¸ªå­¦ç”Ÿäº§ç”Ÿæ‹’ç»å­¦ä¹ æƒ°æ€§ï¼Œé‚£ä¹ˆæ˜¯æ•‘ä¸å›æ¥äº†ã€‚`â€

ç°åœ¨å’Œä»¥å‰æ˜¯ä¸ä¸€æ ·çš„ï¼Œä¸°å¯Œçš„èµ„æ–™ã€é€”å¾„å¹¿ã€å¼€æºç¤¾åŒºçš„å®Œå–„ï¼Œè™½ç„¶è¿™äº›èµ„æ–™é‡Œé¢å¯èƒ½ä¼šå¤¹æ‚ç€è¿‡å¤šçš„å¹¿å‘Šã€‚è¿™ä¹Ÿè®©å¾ˆå¤šåˆå­¦è€…éš¾ä»¥æ‰¾åˆ°é€‚åˆè‡ªå·±çš„èµ„æ–™ï¼Œåˆ°äº†æœ€åéƒ½æ˜¯çœ‹åˆ°æœ‰äººæ¨èç›¸å…³çš„æ–‡ç« æˆ–è€…çŸ¥è¯†ç‚¹ç«‹å³å±è”½æˆ–è€…å½“ä½œæ²¡çœ‹åˆ°ã€‚

è€è¯åŸºç¡€è¯´ï¼šâ€œ`ç å†œéœ€è¦åè°ƒå¥½è½¯ä»¶è®¾è®¡å’Œå®ç°æˆæœ¬çš„åº¦ã€‚`â€

æœ‰æ—¶å€™ä¸€ä¸ªè½¯ä»¶çš„æ¶æ„è®¾è®¡éœ€è¦ç¬¦åˆå½“å‰æ¡ä»¶ä¸‹çš„å„é¡¹å› ç´ ï¼Œå¾€å¾€ä¸èƒ½å› ä¸ºå¿ƒä¸­æƒ³å½“ç„¶çš„æœ‰æŸä¸ªè“å›¾ï¼Œå°±å»å¼€å§‹æ‰§è¡Œã€‚ä¹Ÿè®¸è™½ç„¶ä½ çš„è®¾è®¡æ˜¯éå¸¸ä¼˜ç§€çš„ï¼Œä½†æ˜¯æ”¾åœ¨å½“å‰ç¯å¢ƒä¸‹å¾ˆéš¾æ»¡è¶³ä¸šåŠ¡çš„æ—¶é—´è¦æ±‚ï¼Œå½“ä¸€ä¸ªä¸šåŠ¡çš„åŸºæœ¬è¯‰æ±‚ä¸èƒ½æ»¡è¶³åï¼Œå°±å¾ˆéš¾æ‹‰åŠ¨å¸‚åœºã€‚æ²¡æœ‰äº§å“çš„DAUæ”¯æ’‘ï¼Œæœ€åæ•´ä¸ªç ”å‘çš„é¡¹ç›®ä¹Ÿä¼šå› æ­¤åœæ»ã€‚ä½†ç ”å‘åˆä¸èƒ½ä¸€å›¢ä¹±éº»çš„å†™ä»£ç ï¼Œå› æ­¤éœ€è¦æ‰¾å¥½ä¸€ä¸ªé€‚åˆçš„åº¦ï¼Œæ¯”å¦‚å¯ä»¥æ­å»ºè‰¯å¥½çš„åœ°åŸºï¼Œå®ç°ä¸Šå¯æ‰©å±•ã€‚ä½†åœ¨å…·ä½“çš„åŠŸèƒ½ä¸Šå¯ä»¥å…ˆç®€åŒ–å®ç°ï¼Œéšç€æ´»ä¸‹æ¥äº†å†ç»§ç»­å®Œå–„è¿­ä»£ã€‚

### è§‚å¯Ÿè€…æ¨¡å¼ä»‹ç»

![w9cL6.png](https://i.im5i.com/2021/04/24/w9cL6.png)

ç®€å•æ¥è®²è§‚å¯Ÿè€…ğŸ•µğŸ½â€â™‚ï¸æ¨¡å¼ï¼Œå°±æ˜¯å½“ä¸€ä¸ªè¡Œä¸ºå‘ç”Ÿæ—¶ä¼ é€’ä¿¡æ¯ç»™å¦å¤–ä¸€ä¸ªç”¨æˆ·æ¥æ”¶åšå‡ºç›¸åº”çš„å¤„ç†ï¼Œä¸¤è€…ä¹‹é—´æ²¡æœ‰ç›´æ¥çš„è€¦åˆå…³è”ã€‚

é™¤äº†ç”Ÿæ´»ä¸­çš„åœºæ™¯å¤–ï¼Œåœ¨æˆ‘ä»¬ç¼–ç¨‹å¼€å‘ä¸­ä¹Ÿä¼šå¸¸ç”¨åˆ°ä¸€äº›è§‚å¯Ÿè€…çš„æ¨¡å¼æˆ–è€…ç»„ä»¶ï¼Œä¾‹å¦‚æˆ‘ä»¬ç»å¸¸ä½¿ç”¨çš„MQæœåŠ¡ï¼Œè™½ç„¶MQæœåŠ¡æ˜¯æœ‰ä¸€ä¸ªé€šçŸ¥ä¸­å¿ƒå¹¶ä¸æ˜¯æ¯ä¸€ä¸ªç±»æœåŠ¡è¿›è¡Œé€šçŸ¥ï¼Œä½†æ•´ä½“ä¸Šä¹Ÿå¯ä»¥ç®—ä½œæ˜¯è§‚å¯Ÿè€…æ¨¡å¼çš„æ€è·¯è®¾è®¡ã€‚å†æ¯”å¦‚å¯èƒ½æœ‰åšè¿‡çš„ä¸€äº›ç±»ä¼¼äº‹ä»¶ç›‘å¬æ€»çº¿ï¼Œè®©ä¸»çº¿æœåŠ¡ä¸å…¶ä»–è¾…çº¿ä¸šåŠ¡æœåŠ¡åˆ†ç¦»ï¼Œä¸ºäº†ä½¿ç³»ç»Ÿé™ä½è€¦åˆå’Œå¢å¼ºæ‰©å±•æ€§ï¼Œä¹Ÿä¼šä½¿ç”¨è§‚å¯Ÿè€…æ¨¡å¼è¿›è¡Œå¤„ç†ã€‚

## åœºæ™¯æ¨¡æ‹Ÿ

### åœºæ™¯ä»‹ç»

![w9Eq8.png](https://i.im5i.com/2021/04/24/w9Eq8.png)

**åœ¨æœ¬æ¡ˆä¾‹ä¸­æˆ‘ä»¬æ¨¡æ‹Ÿæ¯æ¬¡å°å®¢è½¦æŒ‡æ ‡æ‘‡å·äº‹ä»¶é€šçŸ¥åœºæ™¯(çœŸå®çš„ä¸ä¼šç”±å®˜ç½‘ç»™ä½ å‘æ¶ˆæ¯)**

å¯èƒ½å¤§éƒ¨åˆ†äººçœ‹åˆ°è¿™ä¸ªæ¡ˆä¾‹ä¸€å®šä¼šæƒ³åˆ°è‡ªå·±æ¯æ¬¡æ‘‡å·éƒ½ä¸ä¸­çš„åœºæ™¯ï¼Œæ”¶åˆ°ä¸€ä¸ªé—æ†¾çš„çŸ­ä¿¡é€šçŸ¥ã€‚å½“ç„¶ç›®å‰çš„æ‘‡å·ç³»ç»Ÿå¹¶ä¸ä¼šç»™ä½ å‘çŸ­ä¿¡ï¼Œè€Œæ˜¯ç”±ç™¾åº¦æˆ–è€…ä¸€äº›å…¶ä»–æ’ä»¶å‘çš„çŸ­ä¿¡ã€‚é‚£ä¹ˆå‡å¦‚è¿™ä¸ªç±»ä¼¼çš„æ‘‡å·åŠŸèƒ½å¦‚æœç”±ä½ æ¥å¼€å‘ï¼Œå¹¶ä¸”éœ€è¦å¯¹å¤–éƒ¨çš„ç”¨æˆ·åšä¸€äº›äº‹ä»¶é€šçŸ¥ä»¥åŠéœ€è¦åœ¨ä¸»æµç¨‹å¤–å†æ·»åŠ ä¸€äº›é¢å¤–çš„è¾…åŠ©æµç¨‹æ—¶è¯¥å¦‚ä½•å¤„ç†å‘¢ï¼Ÿ

åŸºæœ¬å¾ˆå¤šäººå¯¹äºè¿™æ ·çš„é€šçŸ¥äº‹ä»¶ç±»çš„å®ç°å¾€å¾€æ¯”è¾ƒç²—çŠ·ï¼Œç›´æ¥åœ¨ç±»é‡Œé¢å°±æ·»åŠ äº†ã€‚1æ˜¯è€ƒè™‘ğŸ¤”è¿™å¯èƒ½ä¸ä¼šæ€ä¹ˆæ‰©å±•ï¼Œ2æ˜¯å‹æ ¹å°±æ²¡è€ƒè™‘ğŸ˜„è¿‡ã€‚ä½†å¦‚æœä½ æœ‰ä»”ç»†æ€è€ƒè¿‡ä½ çš„æ ¸å¿ƒç±»åŠŸèƒ½ä¼šå‘ç°ï¼Œè¿™é‡Œé¢æœ‰ä¸€äº›æ ¸å¿ƒä¸»é“¾è·¯ï¼Œè¿˜æœ‰ä¸€éƒ¨åˆ†æ˜¯è¾…åŠ©åŠŸèƒ½ã€‚æ¯”å¦‚å®Œæˆäº†æŸä¸ªè¡Œä¸ºåéœ€è¦è§¦å‘MQç»™å¤–éƒ¨ï¼Œä»¥åŠåšä¸€äº›æ¶ˆæ¯PUSHç»™ç”¨æˆ·ç­‰ï¼Œè¿™äº›éƒ½ä¸ç®—åšæ˜¯æ ¸å¿ƒæµç¨‹é“¾è·¯ï¼Œæ˜¯å¯ä»¥é€šè¿‡äº‹ä»¶é€šçŸ¥çš„æ–¹å¼è¿›è¡Œå¤„ç†ã€‚

é‚£ä¹ˆæ¥ä¸‹æ¥æˆ‘ä»¬å°±ä½¿ç”¨è¿™æ ·çš„è®¾è®¡æ¨¡å¼æ¥ä¼˜åŒ–é‡æ„æ­¤åœºæ™¯ä¸‹çš„ä»£ç ã€‚

### ä»£ç ç›®å½•

```markdown
- observer-model-1
  - src.main.java.com.hcy
    - MinibusTargetService.java
```

### æ¥å£ä»£ç 

```java
/**
 * å°å®¢è½¦æŒ‡æ ‡è°ƒæ§æœåŠ¡
 * @author HCY
 * @since 2021/4/24 1:43 ä¸‹åˆ
*/
public class MinibusTargetService {

    /**
     *  æ¨¡æ‹Ÿæ‘‡å·ï¼Œä½†ä¸æ˜¯æ‘‡å·ç®—æ³•
     * @author HCY
     * @since 2021/4/24 1:43 ä¸‹åˆ
     * @param uId: ç”¨æˆ·åºå·
     * @return java.lang.String
    */
    public String lottery(String uId) {
        return Math.abs(uId.hashCode()) % 2 == 0 ? "æ­å–œä½ ï¼Œç¼–ç ".concat(uId).concat("åœ¨æœ¬æ¬¡æ‘‡å·ä¸­ç­¾") : "å¾ˆé—æ†¾ï¼Œç¼–ç ".concat(uId).concat("åœ¨æœ¬æ¬¡æ‘‡å·æœªä¸­ç­¾æˆ–æ‘‡å·èµ„æ ¼å·²è¿‡æœŸ");
    }
}
```

## æ­£å¸¸è§£å†³æ–¹æ¡ˆ

### ä»£ç ç›®å½•

```markdown
- observer-model-2
  - src.main.java.com.hcy
    - LotteryResult.java
    - LotteryService.java
    - LotteryServiceImpl.java
```

### ä»£ç å®ç°

```java
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

import java.util.Date;

public class LotteryServiceImpl implements LotteryService {

    private Logger logger = LoggerFactory.getLogger(LotteryServiceImpl.class);

    private MinibusTargetService minibusTargetService = new MinibusTargetService();

    @Override
    public LotteryResult doDraw(String uId) {
        // æ‘‡å·
        String lottery = minibusTargetService.lottery(uId);
        // å‘çŸ­ä¿¡
        logger.info("ç»™ç”¨æˆ· {} å‘é€çŸ­ä¿¡é€šçŸ¥(çŸ­ä¿¡)ï¼š{}", uId, lottery);
        // å‘MQæ¶ˆæ¯
        logger.info("è®°å½•ç”¨æˆ· {} æ‘‡å·ç»“æœ(MQ)ï¼š{}", uId, lottery);
        // ç»“æœ
        return new LotteryResult(uId, lottery, new Date());
    }

}
```

## è§‚å¯Ÿè€…æ¨¡å¼ é‡æ„ä»£ç 

### ä»£ç ç›®å½•

```markdown
- observer-model-3
  - src.main.java.com.hcy
    - event
      - listener
        - EventListener.java
        - MessageEventListener.java
        - MQEventListener.java
      - EventManager.java
    - LotteryResult.java
    - LotteryService.java
    - LotteryServiceImpl.java
```

### æ¨¡å‹ç»“æ„

![w9UEU.png](https://i.im5i.com/2021/04/24/w9UEU.png)

```markdown
- ä»ä¸Šå›¾å¯ä»¥åˆ†ä¸ºä¸‰å¤§å—çœ‹ï¼›äº‹ä»¶ç›‘å¬ã€äº‹ä»¶å¤„ç†ã€å…·ä½“çš„ä¸šåŠ¡æµç¨‹ï¼Œå¦å¤–åœ¨ä¸šåŠ¡æµç¨‹ä¸­ LotteryService å®šä¹‰çš„æ˜¯æŠ½è±¡ç±»ï¼Œå› ä¸ºè¿™æ ·å¯ä»¥é€šè¿‡æŠ½è±¡ç±»å°†äº‹ä»¶åŠŸèƒ½å±è”½ï¼Œå¤–éƒ¨ä¸šåŠ¡æµç¨‹å¼€å‘è€…ä¸éœ€è¦çŸ¥é“å…·ä½“çš„é€šçŸ¥æ“ä½œã€‚

- å³ä¸‹è§’åœ†åœˆå›¾è¡¨ç¤ºçš„æ˜¯æ ¸å¿ƒæµç¨‹ä¸éæ ¸å¿ƒæµç¨‹çš„ç»“æ„ï¼Œä¸€èˆ¬åœ¨å¼€å‘ä¸­ä¼šæŠŠä¸»çº¿æµç¨‹å¼€å‘å®Œæˆåï¼Œå†ä½¿ç”¨é€šçŸ¥çš„æ–¹å¼å¤„ç†è¾…åŠ©æµç¨‹ã€‚ä»–ä»¬å¯ä»¥æ˜¯å¼‚æ­¥çš„ï¼Œåœ¨MQä»¥åŠå®šæ—¶ä»»åŠ¡çš„å¤„ç†ä¸‹ï¼Œä¿è¯æœ€ç»ˆä¸€è‡´æ€§ã€‚
```

### ä»£ç å®ç°

```java
/**
 * äº‹ä»¶ç›‘å¬æ¥å£å®šä¹‰
 * @author HCY
 * @since 2021/4/24 2:24 ä¸‹åˆ
*/
public interface EventListener {

    void doEvent(LotteryResult result);

}
```

```java
/**
 * çŸ­æ¶ˆæ¯äº‹ä»¶
 * @author HCY
 * @since 2021/4/24 2:24 ä¸‹åˆ
*/
public class MessageEventListener implements EventListener {

    private Logger logger = LoggerFactory.getLogger(MessageEventListener.class);

    @Override
    public void doEvent(LotteryResult result) {
        logger.info("ç»™ç”¨æˆ· {} å‘é€çŸ­ä¿¡é€šçŸ¥(çŸ­ä¿¡)ï¼š{}", result.getuId(), result.getMsg());
    }

}
```

```java
/**
 * MQå‘é€äº‹ä»¶
 * @author HCY
 * @since 2021/4/24 2:25 ä¸‹åˆ
*/
public class MQEventListener implements EventListener {

    private Logger logger = LoggerFactory.getLogger(MQEventListener.class);

    @Override
    public void doEvent(LotteryResult result) {
        logger.info("è®°å½•ç”¨æˆ· {} æ‘‡å·ç»“æœ(MQ)ï¼š{}", result.getuId(), result.getMsg());
    }

}
```

```java
/**
 * äº‹ä»¶å¤„ç†ç±»
 * @author HCY
 * @since 2021/4/24 2:25 ä¸‹åˆ
*/
public class EventManager {

    Map<Enum<EventType>, List<EventListener>> listeners = new HashMap<>();

    public EventManager(Enum<EventType>... operations) {
        for (Enum<EventType> operation : operations) {
            this.listeners.put(operation, new ArrayList<EventListener>());
        }
    }

    public enum EventType {
        MQ, Message
    }

    /**
     * è®¢é˜…
     * @param eventType äº‹ä»¶ç±»å‹
     * @param listener  ç›‘å¬
     */
    public void subscribe(Enum<EventType> eventType, EventListener listener) {
        List<EventListener> users = listeners.get(eventType);
        users.add(listener);
    }

    /**
     * å–æ¶ˆè®¢é˜…
     * @param eventType äº‹ä»¶ç±»å‹
     * @param listener  ç›‘å¬
     */
    public void unsubscribe(Enum<EventType> eventType, EventListener listener) {
        List<EventListener> users = listeners.get(eventType);
        users.remove(listener);
    }

    /**
     * é€šçŸ¥
     * @param eventType äº‹ä»¶ç±»å‹
     * @param result    ç»“æœ
     */
    public void notify(Enum<EventType> eventType, LotteryResult result) {
        List<EventListener> users = listeners.get(eventType);
        for (EventListener listener : users) {
            listener.doEvent(result);
        }
    }

}
```

```java
/**
 * ä¸šåŠ¡æŠ½è±¡ç±»æ¥å£
 * @author HCY
 * @since 2021/4/24 2:26 ä¸‹åˆ
*/
public abstract class LotteryService {

    private EventManager eventManager;

    public LotteryService() {
        eventManager = new EventManager(EventManager.EventType.MQ, EventManager.EventType.Message);
        eventManager.subscribe(EventManager.EventType.MQ, new MQEventListener());
        eventManager.subscribe(EventManager.EventType.Message, new MessageEventListener());
    }

    public LotteryResult draw(String uId) {
        LotteryResult lotteryResult = doDraw(uId);
        // éœ€è¦ä»€ä¹ˆé€šçŸ¥å°±ç»™è°ƒç”¨ä»€ä¹ˆæ–¹æ³•
        eventManager.notify(EventManager.EventType.MQ, lotteryResult);
        eventManager.notify(EventManager.EventType.Message, lotteryResult);
        return lotteryResult;
    }

    protected abstract LotteryResult doDraw(String uId);

}
```

```java
/**
 * ä¸šåŠ¡æ¥å£å®ç°ç±»
 * @author HCY
 * @since 2021/4/24 2:26 ä¸‹åˆ
*/
public class LotteryServiceImpl extends LotteryService {

    private MinibusTargetService minibusTargetService = new MinibusTargetService();

    @Override
    protected LotteryResult doDraw(String uId) {
        // æ‘‡å·
        String lottery = minibusTargetService.lottery(uId);
        // ç»“æœ
        return new LotteryResult(uId, lottery, new Date());
    }

}
```

## æ€»ç»“

```markdown
- ä»æˆ‘ä»¬æœ€åŸºæœ¬çš„è¿‡ç¨‹å¼å¼€å‘ä»¥åŠåæ¥ä½¿ç”¨è§‚å¯Ÿè€…æ¨¡å¼é¢å‘å¯¹è±¡å¼€å‘ï¼Œå¯ä»¥çœ‹åˆ°è®¾è®¡æ¨¡å¼æ”¹é€ åï¼Œæ‹†åˆ†å‡ºäº†æ ¸å¿ƒæµç¨‹ä¸è¾…åŠ©æµç¨‹çš„ä»£ç ã€‚ä¸€èˆ¬ä»£ç ä¸­çš„æ ¸å¿ƒæµç¨‹ä¸ä¼šç»å¸¸å˜åŒ–ã€‚ä½†è¾…åŠ©æµç¨‹ä¼šéšç€ä¸šåŠ¡çš„å„ç§å˜åŒ–è€Œå˜åŒ–ï¼ŒåŒ…æ‹¬ï¼›è¥é”€ã€è£‚å˜ã€ä¿ƒæ´»ç­‰ç­‰ï¼Œå› æ­¤ä½¿ç”¨è®¾è®¡æ¨¡å¼æ¶è®¾ä»£ç å°±æ˜¾å¾—éå¸¸æœ‰å¿…è¦ã€‚

- æ­¤ç§è®¾è®¡æ¨¡å¼ä»ç»“æ„ä¸Šæ˜¯æ»¡è¶³å¼€é—­åŸåˆ™çš„ï¼Œå½“ä½ éœ€è¦æ–°å¢å…¶ä»–çš„ç›‘å¬äº‹ä»¶æˆ–è€…ä¿®æ”¹ç›‘å¬é€»è¾‘ï¼Œæ˜¯ä¸éœ€è¦æ”¹åŠ¨äº‹ä»¶å¤„ç†ç±»çš„ã€‚ä½†æ˜¯å¯èƒ½ä½ ä¸èƒ½æ§åˆ¶è°ƒç”¨é¡ºåºä»¥åŠéœ€è¦åšä¸€äº›äº‹ä»¶ç»“æœçš„è¿”å›ç»§ç»­æ“ä½œï¼Œæ‰€ä»¥ä½¿ç”¨çš„è¿‡ç¨‹æ—¶éœ€è¦è€ƒè™‘åœºæ™¯çš„åˆç†æ€§ã€‚
```

